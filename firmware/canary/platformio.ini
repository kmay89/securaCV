; ═══════════════════════════════════════════════════════════════
; SecuraCV Canary — PlatformIO Build Configuration
; ═══════════════════════════════════════════════════════════════
;
; Build Optimization for Fast Iteration:
; - Modular library components for incremental builds
; - ESP-IDF component trimming (no Bluetooth compile)
; - Debug/Release profiles with appropriate optimization levels
; - OTA-compatible partition layout
;
; Usage:
;   pio run                       # Default dev build
;   pio run -e dev                # Dev build with verbose logging
;   pio run -e release            # Production build
;   pio run -e dev_ha             # Dev + Home Assistant MQTT
;   pio run -e release_ha         # Production + Home Assistant
;   pio run -e minimal            # Crypto/GPS only (fastest build)
;   pio run -e dev -t upload      # Build and flash via USB
;
; ═══════════════════════════════════════════════════════════════

[platformio]
default_envs = dev

; ─── Shared settings ──────────────────────────────────────────
[env]
platform = espressif32 @ ^6.5.0
board = seeed_xiao_esp32s3
framework = arduino
board_build.partitions = partitions_ota.csv
board_build.arduino.memory_type = qio_opi

; Core libraries (always included)
lib_deps =
    rweather/Crypto @ ^0.4.0
    bblanchon/ArduinoJson @ ^7.0.0

; Board-specific build flags (always applied)
build_flags =
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; XIAO ESP32S3 Sense SD card pins
    -DSD_CS_PIN=21
    -DSD_SCK_PIN=7
    -DSD_MISO_PIN=8
    -DSD_MOSI_PIN=9
    ; GPS UART pins
    -DGPS_RX_PIN=44
    -DGPS_TX_PIN=43

monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; ─── DEV: Fast iteration ──────────────────────────────────────
[env:dev]
build_type = debug
build_flags =
    ${env.build_flags}
    -Og                          ; Debug-friendly optimization (fast compile)
    -DCORE_DEBUG_LEVEL=4         ; ESP32 verbose logging
    -DSECURACV_BUILD_DEV=1
    ; All features enabled for dev
    -DFEATURE_SD_STORAGE=1
    -DFEATURE_WIFI_AP=1
    -DFEATURE_HTTP_SERVER=1
    -DFEATURE_CAMERA_PEEK=1
    -DFEATURE_TAMPER_GPIO=0
    -DFEATURE_WATCHDOG=1
    -DFEATURE_STATE_LOG=1
    -DFEATURE_OTA_UPDATE=1
    -DFEATURE_MESH_NETWORK=0
    -DFEATURE_BLUETOOTH=0
    ; Debug output
    -DDEBUG_NMEA=0
    -DDEBUG_CBOR=0
    -DDEBUG_CHAIN=0
    -DDEBUG_VERIFY=0
    -DDEBUG_HTTP=1

; Faster linking for dev
build_unflags = -Os

; ─── RELEASE: Production firmware ─────────────────────────────
[env:release]
build_type = release
build_flags =
    ${env.build_flags}
    -Os                          ; Size optimization
    -DCORE_DEBUG_LEVEL=1         ; Errors only
    -DSECURACV_BUILD_RELEASE=1
    -DFEATURE_SD_STORAGE=1
    -DFEATURE_WIFI_AP=1
    -DFEATURE_HTTP_SERVER=1
    -DFEATURE_CAMERA_PEEK=1
    -DFEATURE_TAMPER_GPIO=0
    -DFEATURE_WATCHDOG=1
    -DFEATURE_STATE_LOG=1
    -DFEATURE_OTA_UPDATE=1
    -DFEATURE_MESH_NETWORK=0
    -DFEATURE_BLUETOOTH=0
    -DDEBUG_NMEA=0
    -DDEBUG_CBOR=0
    -DDEBUG_CHAIN=0
    -DDEBUG_VERIFY=0
    -DDEBUG_HTTP=0

; ─── DEV + HA: Dev build with Home Assistant MQTT ─────────────
[env:dev_ha]
extends = env:dev
build_flags =
    ${env:dev.build_flags}
    -DFEATURE_HA_MQTT=1
    -DFEATURE_HA_DISCOVERY=1
lib_deps =
    ${env.lib_deps}
    knolleary/PubSubClient @ ^2.8

; ─── RELEASE + HA: Production with Home Assistant ─────────────
[env:release_ha]
extends = env:release
build_flags =
    ${env:release.build_flags}
    -DFEATURE_HA_MQTT=1
    -DFEATURE_HA_DISCOVERY=1
lib_deps =
    ${env.lib_deps}
    knolleary/PubSubClient @ ^2.8

; ─── MINIMAL: Crypto + GPS only (no WiFi/SD/camera) ──────────
[env:minimal]
extends = env:dev
build_flags =
    ${env.build_flags}
    -Og
    -DCORE_DEBUG_LEVEL=4
    -DSECURACV_BUILD_DEV=1
    -DFEATURE_SD_STORAGE=0
    -DFEATURE_WIFI_AP=0
    -DFEATURE_HTTP_SERVER=0
    -DFEATURE_CAMERA_PEEK=0
    -DFEATURE_TAMPER_GPIO=0
    -DFEATURE_WATCHDOG=1
    -DFEATURE_STATE_LOG=1
    -DFEATURE_OTA_UPDATE=0
    -DFEATURE_MESH_NETWORK=0
    -DFEATURE_BLUETOOTH=0
    -DDEBUG_NMEA=0
    -DDEBUG_CBOR=0
    -DDEBUG_CHAIN=0
    -DDEBUG_VERIFY=0
    -DDEBUG_HTTP=0

; ─── FULL: All features enabled (mesh + bluetooth) ───────────
[env:full]
extends = env:dev
build_flags =
    ${env:dev.build_flags}
    -DFEATURE_MESH_NETWORK=1
    -DFEATURE_BLUETOOTH=1
