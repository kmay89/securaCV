; ============================================================================
; SecuraCV Canary — PlatformIO Secure Build Environment
; ERRERlabs
;
; Add this as an environment in your platformio.ini:
;   [env:canary_secure]
;   extends = env:canary    ; your base environment
;   extra_configs = platformio_secure.ini
;
; Or copy the relevant settings into your existing env.
; ============================================================================

[env:canary_secure]
platform = espressif32
board = esp32-s3-devkitc-1
framework = espidf

; ── Board Configuration ────────────────────────────────────────────────────
board_build.flash_mode = dio
board_build.flash_size = 16MB
board_build.f_flash = 80000000L

; Use custom partition table with encrypted flag
board_build.partitions = partitions_secure.csv

; ── ESP-IDF Security menuconfig overrides ──────────────────────────────────
; These map to the sdkconfig.defaults.secure settings.
; PlatformIO applies these via SDKCONFIG_DEFAULTS.

board_build.cmake_extra_args =
    -DSDKCONFIG_DEFAULTS="sdkconfig.defaults;sdkconfig.defaults.secure"

; ── Signing ────────────────────────────────────────────────────────────────
; For development builds, you can use pre-signed images.
; For production, the provisioning script handles signing.

; Uncomment and set your key path:
; board_build.secure_boot_signing_key = keys/secure_boot_signing_key_0.pem

; ── Upload Settings ────────────────────────────────────────────────────────
upload_speed = 460800
upload_protocol = esptool

; NOTE: After provisioning with Secure Boot + Flash Encryption,
; you CANNOT flash via USB anymore. Use OTA updates only.
; The provisioning script handles the initial flash.

; ── Monitor ────────────────────────────────────────────────────────────────
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; ── Build Flags ────────────────────────────────────────────────────────────
build_flags =
    -DCANARY_SECURE_BUILD=1
    -DCANARY_BT_DISABLED=1
    -DCONFIG_BT_ENABLED=0
    ; Add your firmware version for anti-rollback
    -DCANARY_FW_VERSION="1.0.0"
