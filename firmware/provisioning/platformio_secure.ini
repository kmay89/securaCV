; ═══════════════════════════════════════════════════════════════
; SecuraCV Canary — Secure PlatformIO Environment
; ═══════════════════════════════════════════════════════════════
;
; This file defines the 'secure' build environment for production
; firmware. It wraps the sdkconfig.defaults.secure configuration.
;
; IMPORTANT: This environment is for Phase 2 (production) builds.
; For development, continue using the 'dev' environment in the
; main platformio.ini file.
;
; Usage:
;   1. Copy this file to firmware/canary/platformio_secure.ini
;   2. Or include it from the main platformio.ini with:
;      extra_configs = ../provisioning/platformio_secure.ini
;   3. Build with: pio run -e secure
;
; The Arduino WAP test files are NOT affected by this configuration.
; This is an ADDITIONAL environment, not a replacement.
;
; ═══════════════════════════════════════════════════════════════

; ─── SECURE: Production build with security features ─────────
;
; This environment:
; - Uses sdkconfig.defaults.secure (BT disabled, NVS encryption)
; - Compiles with size optimization
; - Minimal debug output
; - Prepares for Secure Boot (not enabled until Phase 2 eFuse burn)
;
; To enable full Secure Boot:
; 1. Uncomment sections in sdkconfig.defaults.secure
; 2. Generate keys with: ./generate_keys.sh
; 3. Build with: pio run -e secure
; 4. Provision with: ./provision_canary.sh --phase 2
;
[env:secure]
platform = espressif32 @ ^6.5.0
board = seeed_xiao_esp32s3
framework = arduino
board_build.partitions = ../provisioning/partitions_secure.csv
board_build.arduino.memory_type = qio_opi

; Use secure sdkconfig
board_build.cmake_extra_args =
    -DSDKCONFIG_DEFAULTS=../provisioning/sdkconfig.defaults.secure

; Core libraries (always included)
lib_deps =
    rweather/Crypto @ ^0.4.0
    bblanchon/ArduinoJson @ ^7.0.0

; Production build flags
build_type = release
build_flags =
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; XIAO ESP32S3 Sense SD card pins
    -DSD_CS_PIN=21
    -DSD_SCK_PIN=7
    -DSD_MISO_PIN=8
    -DSD_MOSI_PIN=9
    ; GPS UART pins
    -DGPS_RX_PIN=44
    -DGPS_TX_PIN=43
    ; Production flags
    -Os                          ; Size optimization
    -DCORE_DEBUG_LEVEL=1         ; Errors only
    -DSECURACV_BUILD_SECURE=1
    -DSECURACV_BUILD_RELEASE=1
    ; All features enabled for production
    -DFEATURE_SD_STORAGE=1
    -DFEATURE_WIFI_AP=1
    -DFEATURE_HTTP_SERVER=1
    -DFEATURE_CAMERA_PEEK=1
    -DFEATURE_TAMPER_GPIO=0
    -DFEATURE_WATCHDOG=1
    -DFEATURE_STATE_LOG=1
    -DFEATURE_OTA_UPDATE=1
    -DFEATURE_MESH_NETWORK=0
    -DFEATURE_BLUETOOTH=0        ; DISABLED FOR SECURITY
    ; No debug output
    -DDEBUG_NMEA=0
    -DDEBUG_CBOR=0
    -DDEBUG_CHAIN=0
    -DDEBUG_VERIFY=0
    -DDEBUG_HTTP=0

monitor_speed = 115200

; ─── SECURE + HA: Production with Home Assistant MQTT ─────────
[env:secure_ha]
extends = env:secure
build_flags =
    ${env:secure.build_flags}
    -DFEATURE_HA_MQTT=1
    -DFEATURE_HA_DISCOVERY=1
lib_deps =
    ${env:secure.lib_deps}
    knolleary/PubSubClient @ ^2.8
