; ============================================================================
; SecuraCV Canary OTA Project
; ============================================================================
;
; PlatformIO + ESP-IDF implementation of the OTA update system
; for the SecuraCV Canary privacy witness device.
;
; This is Phase 1 of the migration from Arduino to pure ESP-IDF.
;
; Build:
;   pio run                     # Build default (dev) environment
;   pio run -e production       # Build production environment
;   pio run -t upload           # Build and upload
;   pio run -t menuconfig       # Open sdkconfig menu
;
; Monitor:
;   pio device monitor -b 115200
;
; Test OTA:
;   python tools/mock_ota_server.py firmware.bin 1.1.0
;

[platformio]
default_envs = dev
src_dir = src
include_dir = include

; ============================================================================
; Common environment settings
; ============================================================================

[env]
platform = espressif32@6.5.0
board = seeed_xiao_esp32s3
framework = espidf
monitor_speed = 115200
upload_speed = 921600

; Custom partition table for OTA
board_build.partitions = partitions.csv

; Extra component directories
board_build.cmake_extra_args =
    -DEXTRA_COMPONENT_DIRS=${PROJECT_DIR}/components

; Common build flags
build_flags =
    -DBOARD_HAS_PSRAM
    -DSECURACV_DEVICE_PRODUCT=\"securacv-canary\"

; ============================================================================
; Development environment
; ============================================================================

[env:dev]
; Development: no security features, fast iteration
build_type = debug

build_flags =
    ${env.build_flags}
    -DCORE_DEBUG_LEVEL=4
    -DSECURACV_OTA_MANIFEST_URL=\"https://localhost:8443/manifest.json\"
    -DSECURACV_OTA_SKIP_CERT_VERIFY=1
    -DLOG_LOCAL_LEVEL=ESP_LOG_DEBUG

; Use default sdkconfig for development
board_build.sdkconfig = sdkconfig.defaults

; ============================================================================
; Production environment
; ============================================================================

[env:production]
; Production: security features enabled
build_type = release

build_flags =
    ${env.build_flags}
    -DCORE_DEBUG_LEVEL=1
    -DSECURACV_OTA_MANIFEST_URL=\"https://operacanary.com/api/v1/firmware/manifest.json\"
    -DLOG_LOCAL_LEVEL=ESP_LOG_INFO

; Production sdkconfig with security features
board_build.sdkconfig = sdkconfig.production

; ============================================================================
; Test environment (for unit testing)
; ============================================================================

[env:test]
build_type = test
test_framework = unity
test_build_src = yes

build_flags =
    ${env.build_flags}
    -DCORE_DEBUG_LEVEL=4
    -DSECURACV_OTA_MANIFEST_URL=\"https://localhost:8443/manifest.json\"
    -DSECURACV_OTA_SKIP_CERT_VERIFY=1
