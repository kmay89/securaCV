# Privacy Witness Kernel Configuration
# Copy this to witness.toml and customize for your setup
#
# For Home Assistant users: Use the add-on configuration UI instead.
# This file is for standalone deployments.

# Database path for the sealed event log
db_path = "witness.db"

# Ruleset identifier (change when detection rules change significantly)
ruleset_id = "ruleset:v1.0"

# Event API configuration
[api]
addr = "127.0.0.1:8799"    # Loopback only by default for security
# token_path = "/run/witness/api_token"  # Optional: write token to file

# Ingest backend selection ("file", "rtsp", "v4l2", or "esp32")
[ingest]
backend = "rtsp"

# Local File Configuration (local-only file ingestion)
#
# Provide a local filesystem path to a video file. URL schemes are rejected.
# Example:
#   path = "/var/lib/witness/capture.mp4"
#
[file]
path = "/var/lib/witness/capture.mp4"
target_fps = 10

# RTSP Camera Configuration (optional; not guaranteed in v1)
#
# For real cameras, use the full RTSP URL:
#   url = "rtsp://username:password@192.168.1.100:554/stream1"
#
# Common camera URL patterns:
#   Hikvision:  rtsp://user:pass@IP:554/Streaming/Channels/101
#   Dahua:      rtsp://user:pass@IP:554/cam/realmonitor?channel=1&subtype=0
#   Reolink:    rtsp://user:pass@IP:554/h264Preview_01_main
#   Amcrest:    rtsp://user:pass@IP:554/cam/realmonitor?channel=1&subtype=0
#   Ubiquiti:   rtsp://IP:7447/camera_id
#   ONVIF:      rtsp://user:pass@IP:554/onvif-media/media.amp
#   Generic:    rtsp://user:pass@IP:554/live/ch00_0
#
# For go2rtc proxy (recommended for Home Assistant):
#   url = "rtsp://localhost:8554/front_camera"
#
# For testing without a camera (local dev only):
#   url = "stub://test"  # Generates synthetic frames
#
[rtsp]
url = "rtsp://username:password@192.168.1.100:554/stream1"
target_fps = 10              # Frames per second to process
width = 640                  # Frame width
height = 480                 # Frame height
backend = "auto"             # "auto", "gstreamer", or "ffmpeg"

# V4L2 Camera Configuration (local /dev/video* devices)
#
# For testing without a camera:
#   device = "stub://test"  # Generates synthetic frames
#
[v4l2]
device = "/dev/video0"
target_fps = 10
width = 640
height = 480

# ESP32-S3 Camera Configuration (HTTP MJPEG/JPEG or UDP RTP)
#
# Common ESP32-S3 defaults:
#   MJPEG stream:  http://<camera-ip>:81/stream
#   JPEG snapshot: http://<camera-ip>/capture
#   JPEG snapshot: http://<camera-ip>/jpg
#
# For UDP RTP, bind a local port for incoming packets:
#   url = "udp://0.0.0.0:5004"
#
[esp32]
url = "http://127.0.0.1:81/stream"
# Seeed XIAO Vision AI / Grove Vision AI V2 defaults:
#   http://<device-ip>:81/stream  (some firmware uses :80/stream or /capture)
target_fps = 10

# Detection Backend Configuration
#
# backend = "auto" (uses module auto selection), "stub", "cpu", or "tract"
# tract requires the backend-tract feature and a local ONNX model path.
#
[detect]
backend = "auto"
# tract_model = "/var/lib/witness/model.onnx"

# Zone Configuration
#
# Zones are logical areas being monitored. Events are tagged with zone IDs.
# Zone IDs must match the pattern: zone:[a-z0-9_-]{1,64}
#
[zones]
module_zone_id = "zone:front_boundary"
sensitive = ["zone:front_boundary"]  # Zones that trigger vault sealing

# Event Retention
#
# How long to keep sealed events before pruning.
# Default: 7 days (604800 seconds)
#
[retention]
seconds = 604800  # 7 days

# =============================================================================
# ENVIRONMENT VARIABLES (alternative to config file)
# =============================================================================
#
# Required:
#   DEVICE_KEY_SEED     - Unique secret for device identity (generate with: openssl rand -hex 32)
#
# Optional:
#   WITNESS_CONFIG      - Path to this config file
#   WITNESS_INGEST_BACKEND - Ingest backend ("file", "rtsp", "v4l2", or "esp32")
#   WITNESS_FILE_PATH    - Override file.path
#   WITNESS_FILE_FPS     - Override file.target_fps
#   WITNESS_RTSP_URL    - Override rtsp.url
#   WITNESS_RTSP_BACKEND - Override rtsp.backend ("auto", "gstreamer", "ffmpeg")
#   WITNESS_V4L2_DEVICE - Override v4l2.device
#   WITNESS_ESP32_URL   - Override esp32.url
#   WITNESS_ESP32_FPS   - Override esp32.target_fps
#   WITNESS_DETECT_BACKEND - Override detect.backend ("auto", "stub", "cpu", "tract")
#   WITNESS_TRACT_MODEL - Override detect.tract_model (local ONNX model path)
#   WITNESS_ZONE_ID     - Override zones.module_zone_id
#   WITNESS_SENSITIVE_ZONES - Comma-separated list of sensitive zones
#   WITNESS_API_ADDR    - Override api.addr
#   WITNESS_API_TOKEN_PATH - Override api.token_path
#   WITNESS_RETENTION_SECS - Override retention.seconds
#
# =============================================================================

# =============================================================================
# QUICK START
# =============================================================================
#
# 1. Generate a device key:
#    export DEVICE_KEY_SEED=$(openssl rand -hex 32)
#
# 2. Copy and edit this config:
#    cp config.example.toml witness.toml
#    # Edit rtsp.url to point to your camera
#
# 3. Start the daemon:
#    WITNESS_CONFIG=witness.toml cargo run --bin witnessd
#
# 4. View events:
#    cargo run --bin log_verify -- --db witness.db
#
# =============================================================================
